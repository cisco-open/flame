{{=<% %>=}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Values.servicename }}-agent-<% agentId %>
  namespace: '{{ .Release.Namespace }}'
spec:
  template:
    # activeDeadlineSeconds: <% maxWaitTime %>
    # ttlSecondsAfterFinished: 180 # supported from v1.21
    spec:
      imagePullSecrets:
      - name: ecr-pull-secret
      containers:
      - name: {{ .Values.servicename }}-agent-<% agentId %>
        image: "{{ .Values.generalFullImagePreamble }}{{ .Values.dimage }}:{{ .Values.tagversion }}"
        command: ["/usr/bin/fledgelet"]
        args:
          - "--apiserver"
          - "{{ .Values.servicename }}-apiserver:{{ .Values.componentPorts.apiserver }}"
          - "--notifier"
          - "{{ .Values.servicename }}-notifier:{{ .Values.componentPorts.notifier }}"

        ports:
        - containerPort: {{ .Values.componentPorts.agent }}

        resources:
	  limits:
	    memory: 2Gi
          requests:
            memory: 500Mi

        env:
        - name: FLEDGE_AGENT_ID
          value: <% agentId %>
      restartPolicy: Never
<%={{ }}=%>
