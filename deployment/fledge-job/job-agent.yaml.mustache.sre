{{=<% %>=}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Values.servicename }}-agent-<% agentId %>
  namespace: '{{ .Release.Namespace }}'
spec:
  template:
    # activeDeadlineSeconds: <% maxWaitTime %>
    # ttlSecondsAfterFinished: 180 # supported from v1.21
    spec:
      imagePullSecrets:
      - name: ecr-pull-secret
      containers:
      - name: {{ .Values.servicename }}-agent-<% agentId %>
        image: <% imageLoc %>
        command: ["/usr/bin/fledgelet"]
        args:
          - "--apiserver"
          - "http://{{ .Values.servicename }}-apiserver:{{ .Values.componentPorts.apiserver }}"
          - "--notifier"
          - "{{ .Values.servicename }}-notifier:{{ .Values.componentPorts.notifier }}"

        ports:
        - containerPort: {{ .Values.componentPorts.agent }}

        resources:
          limits:
            memory: 2Gi
          requests:
            memory: 500Mi

        env:
        - name: FLEDGE_AGENT_ID
          value: <% agentId %>

        - name: FLEDGE_AGENT_KEY
          value: <% agentKey %>

        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: fledge-s3-iam
              key: AWS_ACCESS_KEY_ID

        - name: AWS_DEFAULT_REGION
          valueFrom:
            secretKeyRef:
              name: fledge-s3-iam
              key: AWS_DEFAULT_REGION

        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: fledge-s3-iam
              key: AWS_SECRET_ACCESS_KEY

      restartPolicy: Never
<%={{ }}=%>
